/*! author: Junhong-Chen */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CanvasOrgChart=e():t.CanvasOrgChart=e()}(window,(function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=5)}([function(t,e,i){var n=i(9),r=i(10),a=i(11);t.exports=function(t){return n(t)||r(t)||a()}},function(t,e){t.exports=function(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}},function(t,e){function i(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}t.exports=function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}},function(t,e,i){var n=i(6),r=i(7),a=i(8);t.exports=function(t,e){return n(t)||r(t,e)||a()}},function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e,i){"use strict";i.r(e),i.d(e,"default",(function(){return f}));var n=i(3),r=i.n(n),a=i(0),o=i.n(a),h=i(4),d=i.n(h),s=i(2),l=i.n(s),c=i(1),u=i.n(c),f=function(){function t(e){d()(this,t),u()(this,"_lastClickNode",null),u()(this,"_isFindNode",!1),u()(this,"_chartWidth",0),u()(this,"_chartHeight",0),void 0===e&&(e={}),this.width=parseInt(e.width)||0,this.height=parseInt(e.height)||0,this.scale=e.scale||[1,1],this.padding=e.padding||[0,0,0,0],this.nodeWidth=parseInt(e.node.width)||60,this.nodeHeight=parseInt(e.node.height)||160,this.nodeSpacing=e.node.spacing||[20,20],this.nodeColor=e.node.color||"white",this.nodeBackground=e.node.background||"cornflowerblue",this.nodeCustomBackgrounds=e.node.customBackgrounds||[],this.defaultAvatar=e.node.defaultAvatar||"",this.customAvatar=e.node.customAvatar||null,this.nodeTemplate=e.nodeTemplate||[],this.formatParams(),this.originX=parseInt(e.originX)||0+this.padding[3],this.originY=parseInt(e.originY)||0+this.padding[0],this.ctx=null,this._chartWidth=this.originX,this.verifyParameter()}return l()(t,[{key:"currentSelected",get:function(){return this._lastClickNode}}]),l()(t,[{key:"verifyParameter",value:function(){if(!Array.isArray(this.nodeCustomBackgrounds))throw new TypeError("nodeCustomBackgrounds must be an array.");if(!Array.isArray(this.padding)||this.padding.length<1)throw new TypeError("padding must be an non-empty array.");if(!Array.isArray(this.nodeSpacing)||this.nodeSpacing.length<1)throw new TypeError("nodeSpacing must be an non-empty array.");if(!Array.isArray(this.scale))throw new TypeError("scale must be an array.");if("string"!=typeof this.nodeBackground)throw new TypeError("nodeBackground must be a string.");if("function"!=typeof this.nodeTemplate&&!Array.isArray(this.nodeTemplate))throw new TypeError("customNode must be a function or an array.")}},{key:"formatParams",value:function(){switch(this.padding.length){case 1:this.padding[1]=this.padding[0],this.padding[2]=this.padding[0],this.padding[3]=this.padding[0];break;case 2:this.padding[2]=this.padding[0],this.padding[3]=this.padding[1];break;case 3:this.padding[3]=this.padding[1]}1===this.nodeSpacing.length&&(this.nodeSpacing[1]=this.nodeSpacing[0])}},{key:"render",value:function(t,e){if(!t.getContext)throw new Error("can't get canvas context.");if(this.ctx=t.getContext("2d"),!e)throw new Error("data can't be empty.");var i;this.nodeTemplate===[]?this.calculateCoordinate(e,this.originY):this.calculateCustomCoordinate(e,this.originY),this._chartWidth-=this.nodeSpacing[0],this._chartHeight+=this.nodeHeight,this.setCanvasSize(t,this.width||this._chartWidth+this.padding[1],this.height||this._chartHeight+this.padding[2]),(i=this.ctx).scale.apply(i,o()(this.scale)),this.drawChart(this.ctx,e,!1),this.bindClick(t,e)}},{key:"calculateCoordinate",value:function(t,e){var i=t.children.length;if(t.y=e,t.y>this._chartHeight&&(this._chartHeight=t.y),i<=0)t.x=this._chartWidth,this._chartWidth+=this.nodeWidth+this.nodeSpacing[0];else{e+=this.nodeHeight+this.nodeSpacing[1];var n=!0,r=!1,a=void 0;try{for(var o,h=t.children[Symbol.iterator]();!(n=(o=h.next()).done);n=!0){var d=o.value;this.calculateCoordinate(d,e)}}catch(t){r=!0,a=t}finally{try{n||null==h.return||h.return()}finally{if(r)throw a}}t.x=1===i?t.children[0].x:Math.round(t.children[0].x+(t.children[i-1].x-t.children[0].x)/2)}}},{key:"calculateCustomCoordinate",value:function(t,e){var i=t.children.length;if(t.y=e,Array.isArray(this.nodeTemplate)&&this.nodeTemplate.length>0){var n=!0,a=!1,o=void 0;try{for(var h,d=this.nodeTemplate.entries()[Symbol.iterator]();!(n=(h=d.next()).done);n=!0){var s=r()(h.value,2),l=s[0],c=s[1];if(c.checkOwn&&Object.prototype.hasOwnProperty.call(t,c.attributeName)||t[c.attributeName]){t._isCustom=l,t._width=c.width,t._height=c.height;break}}}catch(t){a=!0,o=t}finally{try{n||null==d.return||d.return()}finally{if(a)throw o}}}if(t.y>this._chartHeight&&(this._chartHeight=t.y),i<=0)t.x=this._chartWidth,this._chartWidth+=(t._width||this.nodeWidth)+this.nodeSpacing[0];else{e+=this.nodeHeight+this.nodeSpacing[1];var u=!0,f=!1,y=void 0;try{for(var g,p=t.children[Symbol.iterator]();!(u=(g=p.next()).done);u=!0){var v=g.value;this.calculateCustomCoordinate(v,e)}}catch(t){f=!0,y=t}finally{try{u||null==p.return||p.return()}finally{if(f)throw y}}if(1===i)t.x=t.children[0].x;else{var w=((t.children[0]._width||this.nodeWidth)-this.nodeWidth)/2-((t._width||this.nodeWidth)-this.nodeWidth)/2;t.x=Math.round(t.children[0].x+(t.children[i-1].x-t.children[0].x)/2+w)}}}},{key:"drawChart",value:function(t,e){"function"==typeof this.nodeTemplate?this.nodeTemplate(this,t,e.x,e.y,e):void 0!==e._isCustom?this.nodeTemplate[e._isCustom].draw(this,t,e.x,e.y,e):this.drawNode(t,e.x,e.y,e),this.drawNodeLine(t,e)}},{key:"drawNode",value:function(t,e,i,n){this.drawAvatar(t,e,i,n),t.fillStyle=this.nodeBackground;var r=!0,a=!1,o=void 0;try{for(var h,d=this.nodeCustomBackgrounds[Symbol.iterator]();!(r=(h=d.next()).done);r=!0){var s=h.value;(s.checkOwn&&Object.prototype.hasOwnProperty.call(n,s.attributeName)||void 0!==n[s.attributeName])&&("string"==typeof s.color?t.fillStyle=s.color:t.fillStyle=s.color[n[s.attributeName]])}}catch(t){a=!0,o=t}finally{try{r||null==d.return||d.return()}finally{if(a)throw o}}var l=this.nodeHeight-this.nodeWidth;t.fillRect(e,i+this.nodeWidth,this.nodeWidth,l),t.stroke(),this.drawVerticalText(t,e,i+this.nodeWidth,n._width||this.nodeWidth,l,n.name)}},{key:"drawAvatar",value:function(t,e,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.nodeWidth,a=new Image,o=this;n.avatar?a.src=n.avatar:this.customAvatar&&Object.prototype.hasOwnProperty.call(n,this.customAvatar.attributeName)?a.src=this.customAvatar.avatars[n[this.customAvatar.attributeName]]:a.src=this.defaultAvatar,a.onload=function(){t.drawImage(this,e,i,r,r)},a.onerror=function(){o.drawImageError(t,e,i,r,r)}}},{key:"drawVerticalText",value:function(t,e,i,n,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:10,h=22,d=(r-a.length*h-o)/(a.length-1);t.font="".concat(h,"px serif"),t.textBaseline="bottom",t.fillStyle=this.nodeColor,e+=n/2-h/2,i+=h+o/2;var s=!0,l=!1,c=void 0;try{for(var u,f=a.split("")[Symbol.iterator]();!(s=(u=f.next()).done);s=!0){var y=u.value;t.fillText(y,e,i),i+=h+d}}catch(t){l=!0,c=t}finally{try{s||null==f.return||f.return()}finally{if(l)throw c}}}},{key:"drawNodeLine",value:function(t,e){var i=e.children.length;this.drawSelected(t,e,e._width||this.nodeWidth,e._height||this.nodeHeight,!0),t.strokeStyle="black",t.lineCap="butt";var n=e.x+(e._width||this.nodeWidth)/2;if(e.y>this.originY&&this.drawLine(t,[n,e.y-2],[n,e.y-this.nodeSpacing[1]/2]),i>0){var r=e.y+(e._height||this.nodeHeight);this.drawLine(t,[n,r+2],[n,r+this.nodeSpacing[1]/2+this.nodeHeight-(e._height||this.nodeHeight)]);var a=e.y+this.nodeHeight+this.nodeSpacing[1]/2+1;this.drawLine(t,[e.children[0].x+(e.children[0]._width||this.nodeWidth)/2,a],[e.children[i-1].x+(e.children[i-1]._width||this.nodeWidth)/2,a]);var o=!0,h=!1,d=void 0;try{for(var s,l=e.children[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var c=s.value;this.drawChart(t,c)}}catch(t){h=!0,d=t}finally{try{o||null==l.return||l.return()}finally{if(h)throw d}}}}},{key:"drawSelected",value:function(t,e,i,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=e.x-1,o=e.y-1;i+=2,n+=2,t.lineCap="round",t.strokeStyle=r?"white":"black",this.drawLine(t,[a,o],[a+i,o]),this.drawLine(t,[a+i,o],[a+i,o+n]),this.drawLine(t,[a+i,o+n],[a,o+n]),this.drawLine(t,[a,o+n],[a,o])}},{key:"drawLine",value:function(t,e,i){t.beginPath(),t.lineWidth=2,t.moveTo.apply(t,o()(e)),t.lineTo.apply(t,o()(i)),t.stroke()}},{key:"setCanvasSize",value:function(t,e,i){t.setAttribute("width",e),t.setAttribute("height",i)}},{key:"bindClick",value:function(t,e){var i=this;t.addEventListener("click",(function(t){var n=this.getBoundingClientRect(),r=(t.clientX-n.left)/i.scale[0],a=(t.clientY-n.top)/i.scale[1];i.isPointInRect([i.originX,i.originY],i._chartWidth-i.padding[3],i._chartHeight-i.padding[0],r,a)?i._lastClickNode&&i.isPointInRect([i._lastClickNode.x,i._lastClickNode.y],i._lastClickNode._width||i.nodeWidth,i._lastClickNode._height||i.nodeHeight,r,a)||(i._isFindNode=!1,i.isClickNode(e,r,a),i._isFindNode||(i._lastClickNode&&i.drawSelected(i.ctx,i._lastClickNode,i._lastClickNode._width||i.nodeWidth,i._lastClickNode._height||i.nodeHeight,!0),i._lastClickNode=null)):(i._lastClickNode&&i.drawSelected(i.ctx,i._lastClickNode,i._lastClickNode._width||i.nodeWidth,i._lastClickNode._height||i.nodeHeight,!0),i._lastClickNode=null)}))}},{key:"isClickNode",value:function(t,e,i){if(this.isPointInRect([t.x,t.y],t._width||this.nodeWidth,t._height||this.nodeHeight,e,i))return this._lastClickNode&&this.drawSelected(this.ctx,this._lastClickNode,this._lastClickNode._width||this.nodeWidth,this._lastClickNode._height||this.nodeHeight,!0),this._lastClickNode=t,this._isFindNode=!0,void this.drawSelected(this.ctx,t,this._lastClickNode._width||this.nodeWidth,this._lastClickNode._height||this.nodeHeight);if(t.children.length>0&&!this._isFindNode){var n=!0,r=!1,a=void 0;try{for(var o,h=t.children[Symbol.iterator]();!(n=(o=h.next()).done);n=!0){var d=o.value;this.isClickNode(d,e,i)}}catch(t){r=!0,a=t}finally{try{n||null==h.return||h.return()}finally{if(r)throw a}}}}},{key:"isPointInRect",value:function(t,e,i,n,r){var a={x:n,y:r},o={x:t[0],y:t[1]},h={x:t[0]+e,y:t[1]},d={x:t[0]+e,y:t[1]+i},s={x:t[0],y:t[1]+i};return this.getCrossProduct(a,o,h)*this.getCrossProduct(a,d,s)>=0&&this.getCrossProduct(a,h,d)*this.getCrossProduct(a,s,o)>=0}},{key:"getCrossProduct",value:function(t,e,i){return(i.x-e.x)*(t.y-e.y)-(t.x-e.x)*(i.y-e.y)}},{key:"drawImageError",value:function(t,e,i,n,r){var a=r/2,o=n/5.5,h=n/4,d=n/14;t.beginPath(),t.fillStyle="darkgray",t.strokeStyle="white",t.fillRect(e,i,n,r),t.fillStyle="white",t.font="".concat(h,"px arial"),t.fillText("暂无",e+h/3,i+h/2*3),t.fillText("图片",e+h/3,i+h/2*5),t.arc(e+n-o,i+r/4,h/3,0,2*Math.PI);var s=i+r-a/2;t.lineWidth=2,t.moveTo(e+0,i+r),t.lineTo(e+o,s),this.drawMountain(t,[e+o,s],[e+2*o,s],d),this.drawMountain(t,[e+2*o,s],[e+3*o,s],d,!0),t.lineTo(e+4*o,i+r-a),this.drawMountain(t,[e+4*o,i+r-a],[e+5*o,i+r-a],d),t.lineTo(e+n,i+r-a+.6*o),t.stroke(),t.closePath()}},{key:"drawMountain",value:function(t,e,i,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];r&&(n*=-1),t.moveTo.apply(t,o()(e));var a={x:e[0]+(i[0]-e[0])/4,y:e[1]-n},h={x:i[0]-(i[0]-e[0])/4,y:i[1]-n};t.bezierCurveTo.apply(t,[a.x,a.y,h.x,h.y].concat(o()(i)))}}]),t}()},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}},function(t,e){t.exports=function(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var i=[],n=!0,r=!1,a=void 0;try{for(var o,h=t[Symbol.iterator]();!(n=(o=h.next()).done)&&(i.push(o.value),!e||i.length!==e);n=!0);}catch(t){r=!0,a=t}finally{try{n||null==h.return||h.return()}finally{if(r)throw a}}return i}}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(t,e){t.exports=function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}},function(t,e){t.exports=function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}}])}));